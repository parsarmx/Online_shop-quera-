from models import Product, User


class Store:
    def __init__(self):
        self.products = dict()
        self.users = list()

    def add_product(self, product, amount=1):
        self.products[product] = self.products.get(product, 0) + amount

    def remove_product(self, product, amount=1):
        try:
            if self.products[product] < amount:
                raise Exception('Not Enough Products')
            self.products[product] -= amount
            if self.products[product] == 0:
                del self.products[product]
        except KeyError:
            raise Exception('Not Enough Products')

    def add_user(self, username):
        new_user = User(username)
        if new_user in self.users:
            return None
        self.users.append(new_user)
        return username

    def get_total_asset(self):
        total_asset = 0
        for product, amount in self.products.items():
            total_asset += product.price * amount
        return total_asset

    def get_total_profit(self):
        total_profit = 0
        for user in self.users:
            total_profit += sum([product.price
                                 for product in user.bought_products])
        return total_profit

    def get_comments_by_user(self, user):
        comments_by_user = []
        for product in self.products.keys():
            for comment in product.comments:
                if user == comment.user:
                    comments_by_user.append(comment.text)
        return comments_by_user

    def get_inflation_affected_product_names(self):
        inflation_affected_product_names = []
        product_list = list(self.products.keys())
        product_count = len(product_list)
        for i in range(product_count):
            product = product_list[i]
            if product.name in inflation_affected_product_names:
                continue
            for second_product in product_list[i + 1:]:
                if product.name != second_product.name and \
                        product.price > second_product.price:
                    inflation_affected_product_names.append(product.name)
        return inflation_affected_product_names

    def clean_old_comments(self, date):
        for product in self.products.keys():
            product.comments = [comment
                                for comment in product.comments
                                if comment.date_added >= date]

    def get_comments_by_bought_users(self, product):
        comments_by_bought_users = []
        for comment in product.comments:
            if product in comment.user.bought_products:
                comments_by_bought_users.append(comment.text)
        return comments_by_bought_users
